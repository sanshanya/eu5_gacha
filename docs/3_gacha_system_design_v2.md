# æŠ½å¡ç³»ç»Ÿå®Œæ•´è®¾è®¡æ–‡æ¡£ v2.0


# æ³¨æ„æœ¬æ–‡æ¡£é‡Œå……æ»¡å¹»è§‰æ¯”å¦‚modæ˜¯å¦èƒ½å®ç°ä¹‹ç±»çš„
## æ¦‚è§ˆ (Overview)

æœ¬æ–‡æ¡£æè¿° EU5 Gacha Mod çš„å®Œæ•´æŠ½å¡ç³»ç»Ÿè®¾è®¡ï¼ŒåŒ…æ‹¬æ¦‚ç‡è®¡ç®—ã€éšæœºæ•°ç”Ÿæˆã€ä¿åº•æœºåˆ¶ã€å¥–æ± æ¶æ„ã€‚

---

## 1. æ ¸å¿ƒå˜é‡ (Core Variables)

| å˜é‡å | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `gacha_pity_count` | Integer | 5æ˜Ÿä¿åº•è®¡æ•° (0-89) |
| `gacha_pity_4star_count` | Integer | 4æ˜Ÿä¿åº•è®¡æ•° (0-10) |
| `gacha_total_rolls` | Integer | ç´¯è®¡æŠ½å¡æ€»æ¬¡æ•° |
| `gacha_is_guaranteed` | Boolean | å¤§ä¿åº•æ ‡è¯† (yes/no) |
| `gacha_rand` | Integer | ä¼ªéšæœºæ•° (0-999) |
| `gacha_thresh5` | Integer | 5æ˜Ÿé˜ˆå€¼ (6-1000) |

---

## 2. æ¦‚ç‡æ¨¡å‹ (Probability Model)

### 2.1 äº”æ˜Ÿæ¦‚ç‡

| æŠ½æ•°èŒƒå›´ | åŸºç¡€æ¦‚ç‡ | è½¯ä¿åº•å¢é‡ | å®é™…æ¦‚ç‡ |
|---------|---------|-----------|---------|
| 0-72 | 0.6% | - | 0.6% |
| 73 | 0.6% | +6% | 6.6% |
| 74 | 0.6% | +12% | 12.6% |
| ... | ... | ... | ... |
| 89 | - | - | **100%** (ç¡¬ä¿åº•) |

**å…¬å¼ (Implementation):**
```paradox
gacha_5star_threshold_value = {
    value = 6  # åŸºç¡€ 0.6% (6/1000)
    
    # è½¯ä¿åº•: 73+ æ¯æŠ½ +6%
    if = {
        limit = { var:gacha_pity_count >= 73 }
        add = {
            value = var:gacha_pity_count
            subtract = 73
            multiply = 60  # æ¯æŠ½ +60/1000 = +6%
        }
    }
    
    # ç¡¬ä¿åº•: 89+ å¼ºåˆ¶ 100%
    if = {
        limit = { var:gacha_pity_count >= 89 }
        set = 1000
    }
}
```

### 2.2 å››æ˜Ÿæ¦‚ç‡

| æ¡ä»¶ | æ¦‚ç‡ |
|------|------|
| åŸºç¡€æ¦‚ç‡ | 5.1% (51/1000) |
| ç¡¬ä¿åº• (10æŠ½) | 100% |

### 2.3 ä¸‰æ˜Ÿæ¦‚ç‡

**æ®‹ä½™æ¦‚ç‡**: 100% - 5æ˜Ÿæ¦‚ç‡ - 4æ˜Ÿæ¦‚ç‡

---

## 3. ä¼ªéšæœºæ•°ç”Ÿæˆ (PRNG)

### 3.1 è®¾è®¡è¦æ±‚

âŒ **ç¦æ­¢ä½¿ç”¨**:
- `random_list` (ä¸æ¸¸æˆæ—¥æœŸç»‘å®šï¼Œå¯¼è‡´å¯é¢„æµ‹æ€§)
- `while` å¾ªç¯å–æ¨¡ (å›½åº“å¤§å€¼æ—¶æ€§èƒ½å´©æºƒ)

âœ… **é‡‡ç”¨æ–¹æ¡ˆ**:
- **ç§å­æ··åˆ**: `total_rolls + pity_count + treasury`
- **æ•°å­¦æ³•å–æ¨¡**: `O(1)` å¤æ‚åº¦ï¼Œæ— å¾ªç¯

### 3.2 å®ç°ä»£ç 

```paradox
# æ­¥éª¤ 1: ç”Ÿæˆç§å­
set_variable = { name = gacha_rand value = var:gacha_total_rolls }
change_variable = { name = gacha_rand add = var:gacha_pity_count }
change_variable = { name = gacha_rand add = treasury }  # åŠ¨æ€ç»„ä»¶

# æ­¥éª¤ 2: æ•°å­¦æ³•å–æ¨¡ 1000 (O(1))
# å…¬å¼: Rand = Seed - (1000 * (Seed / 1000))
set_variable = { name = gacha_temp_calc value = var:gacha_rand }
change_variable = { name = gacha_temp_calc divide = 1000 }  # æ•´æ•°é™¤æ³•è‡ªåŠ¨å–æ•´
change_variable = { name = gacha_temp_calc multiply = 1000 }
change_variable = { name = gacha_rand subtract = var:gacha_temp_calc }
remove_variable = gacha_temp_calc

# ç°åœ¨ gacha_rand âˆˆ [0, 999]
```

**æ€§èƒ½å¯¹æ¯”**:
| æ–¹æ³• | å›½åº“=1000 | å›½åº“=1,000,000 | å›½åº“=100,000,000 |
|------|-----------|---------------|----------------|
| whileå¾ªç¯ | ~1æ¬¡ | ~1000æ¬¡ | ~100,000æ¬¡ ğŸ’¥ |
| æ•°å­¦æ³• | 4æ­¥ | 4æ­¥ âœ… | 4æ­¥ âœ… |

### 3.3 éšæœºæ€§éªŒè¯

**ç§å­å˜åŒ–æ€§**:
- `total_rolls`: æ¯æ¬¡æŠ½å¡ +1
- `pity_count`: æ¯æ¬¡æœªä¸­5æ˜Ÿ +1
- `treasury`: å—æ”¶å…¥/æ”¯å‡º/æˆ˜äº‰/å»ºç­‘å½±å“

**åˆ†å¸ƒå‡åŒ€æ€§**:
- 1000 ç§å¯èƒ½ç»“æœ (0-999)
- ä¸é˜ˆå€¼ç›´æ¥å¯¹æ¯”ï¼Œæ— ç²¾åº¦æŸå¤±

---

## 4. äº”æ˜Ÿåˆ¤å®šæµç¨‹ (5-Star Logic)

```
å¼€å§‹æŠ½å¡
  â†“
ç”Ÿæˆ gacha_rand (0-999)
  â†“
è·å– gacha_thresh5
  â†“
rand < thresh5?
  â”œâ”€ æ˜¯ â†’ è§¦å‘5æ˜ŸåŠ¨ç”»äº‹ä»¶ â†’ gacha_handle_5star_outcome
  â”‚         â”œâ”€ is_guaranteed? æ˜¯ â†’ å¿…å®šUP (å¿ƒæµ·)
  â”‚         â””â”€ is_guaranteed? å¦ â†’ 50/50åˆ¤å®š
  â”‚                              â”œâ”€ å¶æ•° â†’ UP (å¿ƒæµ·)
  â”‚                              â””â”€ å¥‡æ•° â†’ å¸¸é©» (é›·ç”µ) + è®¾ç½® is_guaranteed=yes
  â”‚
  â””â”€ å¦ â†’ pity_count + 1 â†’ æ£€æŸ¥4æ˜Ÿ
```

---

## 5. 50/50 æœºåˆ¶ (UP vs Standard)

### 5.1 é—®é¢˜ï¼šå¥‡å¶æ€§é™·é˜±

âŒ **é”™è¯¯å®ç°**:
```paradox
# åªç”¨ treasury
set_variable = { name = gacha_r50 value = treasury }
# å–æ¨¡ 2...
```

**é—®é¢˜**: å¦‚æœæŠ½å¡æ¶ˆè€—æ˜¯å¶æ•° (100é‡‘)ï¼Œtreasury å¥‡å¶æ€§æ°¸ä¸æ”¹å˜ â†’ ç©å®¶æ°¸è¿œæ­ªæˆ–æ°¸ä¸æ­ªã€‚

### 5.2 æ­£ç¡®å®ç°

âœ… **ä¿®å¤æ–¹æ¡ˆ**: æ··åˆ `treasury + total_rolls`

```paradox
# æ··åˆç§å­ (å…³é”®ï¼štotal_rolls æ¯æ¬¡+1ï¼Œæ‰“ç ´é”å®š)
set_variable = { name = gacha_r50 value = treasury }
change_variable = { name = gacha_r50 add = var:gacha_total_rolls }

# æ•°å­¦æ³•å–æ¨¡ 2
set_variable = { name = gacha_r50_calc value = var:gacha_r50 }
change_variable = { name = gacha_r50_calc divide = 2 }
change_variable = { name = gacha_r50_calc multiply = 2 }
change_variable = { name = gacha_r50 subtract = var:gacha_r50_calc }
remove_variable = gacha_r50_calc

# gacha_r50 = 0 (å¶æ•°) â†’ UP
# gacha_r50 = 1 (å¥‡æ•°) â†’ å¸¸é©»
```

**éªŒè¯è¡¨æ ¼**:
| æŠ½æ•° | treasury | total_rolls | ç§å­å’Œ | mod 2 | ç»“æœ |
|------|----------|------------|--------|-------|------|
| 1 | 1001 | 1 | 1002 | 0 | UP |
| 2 | 901 | 2 | 903 | 1 | æ­ª |
| 3 | 801 | 3 | 804 | 0 | UP |

â†’ **å¥‡å¶æ€§æ¯æ¬¡ç¿»è½¬ï¼Œä¿è¯å…¬å¹³æ€§**

---

## 6. å¥–æ± æ¶æ„ (Pool Architecture)

### 6.1 äº”æ˜Ÿæ± 

```paradox
# åœ¨ gacha_handle_5star_outcome ä¸­å¤„ç†
if = { limit = { var:gacha_is_guaranteed = yes }
    gacha_create_xinhai_effect = yes  # å¿…å®šUP
}
else = {
    # 50/50 (è§ä¸ŠèŠ‚)
}
```

### 6.2 äº”æ˜Ÿå¸¸é©»æ± 

```paradox
gacha_standard_5star_pool = {
    # ç›®å‰åªæœ‰é›·ç”µå°†å†›
    gacha_create_raiden_effect = yes
    
    # æœªæ¥æ‰©å±•: ä½¿ç”¨ (treasury + total_rolls) mod N
    # if = { limit = { var:choice = 0 } ... }
}
```

### 6.3 å››æ˜Ÿæ± 

```paradox
gacha_4star_pool = {
    # Seed = treasury + total_rolls
    # Choice = Seed mod 3
    # 0 â†’ é‡‘å¸, 1 â†’ å¨æœ›, 2 â†’ æ­£ç»Ÿæ€§
}
```

---

## 7. ä¿åº•æœºåˆ¶ (Pity System)

### 7.1 äº”æ˜Ÿä¿åº•

| ç±»å‹ | è§¦å‘æ¡ä»¶ | é‡ç½®æ¡ä»¶ |
|------|---------|---------|
| è½¯ä¿åº• | 73+ | è·å¾—5æ˜Ÿ |
| ç¡¬ä¿åº• | 89+ | è·å¾—5æ˜Ÿ |
| å¤§ä¿åº• | æ­ªäº†ä¹‹å | è·å¾—UPè§’è‰² |

**ç‰¹æ®Šè§„åˆ™**: 5æ˜Ÿä¸é‡ç½®4æ˜Ÿä¿åº• (åªå»¶å)

### 7.2 å››æ˜Ÿä¿åº•

| ç±»å‹ | è§¦å‘æ¡ä»¶ | é‡ç½®æ¡ä»¶ |
|------|---------|---------|
| ç¡¬ä¿åº• | 10æŠ½ | è·å¾—4æ˜Ÿ |

**ç‹¬ç«‹è®¡æ•°**: ä¸5æ˜Ÿä¿åº•äº’ä¸å½±å“

---

## 8. å®Œæ•´æŠ½å¡æµç¨‹

```
1. åˆå§‹åŒ–å˜é‡ (pity_count, total_rolls, pity_4star_count)
2. total_rolls + 1, pity_4star_count + 1
3. ç”Ÿæˆä¼ªéšæœºæ•° gacha_rand âˆˆ [0, 999]
4. è®¡ç®—5æ˜Ÿé˜ˆå€¼ gacha_thresh5
5. IF rand < thresh5:
   a. è§¦å‘5æ˜ŸåŠ¨ç”»äº‹ä»¶ (gacha_events.5)
   b. äº‹ä»¶é€‰é¡¹è°ƒç”¨ gacha_handle_5star_outcome
   c. åˆ¤å®šUP/å¸¸é©»
   d. é‡ç½® pity_count = 0
6. ELSE (æœªä¸­5æ˜Ÿ):
   a. pity_count + 1
   b. IF pity_4star_count >= 10 OR rand < 51:
      - è°ƒç”¨ gacha_4star_pool
      - é‡ç½® pity_4star_count = 0
   c. ELSE:
      - è§¦å‘3æ˜Ÿäº‹ä»¶ (gacha_events.2)
```

---

## 9. å…³é”®æ–‡ä»¶æ˜ å°„

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `gacha_logic_effects.txt` | æ ¸å¿ƒæŠ½å¡é€»è¾‘ã€PRNGã€åˆ¤å®šæµç¨‹ |
| `gacha_pools.txt` | å¥–æ± å®šä¹‰ (5æ˜Ÿå¸¸é©»ã€4æ˜Ÿ) |
| `gacha_values.txt` | 5æ˜Ÿæ¦‚ç‡è®¡ç®— (è½¯ä¿åº•/ç¡¬ä¿åº•) |
| `gacha_events.txt` | äº‹ä»¶å®šä¹‰ (åŠ¨ç”»ã€ç»“æœã€å¥–åŠ±) |

---

## 10. æµ‹è¯•éªŒè¯æ¸…å•

- [ ] **åŸºç¡€æ¦‚ç‡**: 100 æ¬¡æŠ½å¡ (pity 0-72) â†’ ~0.6% 5æ˜Ÿ
- [ ] **è½¯ä¿åº•**: pity=73 å•æŠ½ â†’ ~6.6% 5æ˜Ÿ
- [ ] **ç¡¬ä¿åº•**: pity=89 å•æŠ½ â†’ 100% 5æ˜Ÿ
- [ ] **4æ˜Ÿä¿åº•**: è¿ç»­ 10 æŠ½æ— 5æ˜Ÿ â†’ å¿…å‡º4æ˜Ÿ
- [ ] **50/50 å…¬å¹³æ€§**: 100 æ¬¡5æ˜Ÿ â†’ ~50% UP, ~50% å¸¸é©»
- [ ] **å¤§ä¿åº•**: æ­ªäº†ä¹‹åå†ä¸­5æ˜Ÿ â†’ å¿…å®šUP
- [ ] **æ€§èƒ½æµ‹è¯•**: å›½åº“ 1,000,000+ â†’ æ— å¡é¡¿
- [ ] **å¥‡å¶é™·é˜±**: è¿ç»­æŠ½å¡ â†’ ç»“æœåº”éšæœºå˜åŒ–

---

## é™„å½• A: æ¦‚ç‡æœŸæœ›è®¡ç®—

**å¹³å‡5æ˜Ÿå‡ºè´§æŠ½æ•°** (æœ‰è½¯ä¿åº•):
- æœŸæœ›å€¼ â‰ˆ 62.5 æŠ½

**æœ€å·®æƒ…å†µ** (æ¬§çš‡):
- ç¡¬ä¿åº• 90 æŠ½

**å¤§ä¿åº•æœŸæœ›**:
- 2 æ¬¡5æ˜Ÿå¿…å¾—1ä¸ªUP
- æœŸæœ› UP æŠ½æ•° â‰ˆ 125 æŠ½

---

## é™„å½• B: å·²çŸ¥é—®é¢˜ä¸æœªæ¥ä¼˜åŒ–

### å·²ä¿®å¤
- âœ… æ€§èƒ½ç‚¸å¼¹ (while å¾ªç¯)
- âœ… å¥‡å¶é™·é˜± (50/50 é”å®š)
- âœ… random_list æ—¥æœŸç»‘å®š

### æœªæ¥ä¼˜åŒ–
- [ ] æ·»åŠ æ›´å¤š5æ˜Ÿå¸¸é©»è§’è‰² (éœ€å®ç° mod N é€‰æ‹©é€»è¾‘)
- [ ] 4æ˜Ÿè§’è‰²æ±  (ç›®å‰åªæœ‰èµ„æºå¥–åŠ±)
- [ ] æŠ½å¡å†å²è®°å½• (ç”¨äºdebug)
