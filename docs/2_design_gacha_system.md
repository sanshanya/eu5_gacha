# Gacha System Design (æŠ½å¡ç³»ç»Ÿè®¾è®¡)

> **æœ€åæ›´æ–°**: 2025-11-23  
> **å½“å‰ç‰ˆæœ¬**: 2.0 (ç»è¿‡é‡å¤§Bugä¿®å¤)

---

## Part 1: Probability Logic (æ¦‚ç‡é€»è¾‘)

æˆ‘ä»¬é‡‡ç”¨ **"ä¼ªéšæœºæ•°ç”Ÿæˆ (PRNG) + åŠ¨æ€é˜ˆå€¼åˆ¤å®š"** çš„é€»è¾‘ï¼Œå¤åˆ»ã€ŠåŸç¥ã€‹çš„æœºåˆ¶ã€‚

### 1. æ ¸å¿ƒå˜é‡

| å˜é‡å | ç”¨é€” | èŒƒå›´ |
|--------|------|------|
| `gacha_total_rolls` | æ€»æŠ½å¡æ¬¡æ•° | 0~âˆ |
| `gacha_pity_count` | 5æ˜Ÿä¿åº•è®¡æ•° | 0~89 |
| `gacha_pity_4star` | 4æ˜Ÿä¿åº•è®¡æ•° | 0~9 |
| `gacha_block_has_4star` | å½“å‰å—æ˜¯å¦å·²å‡º4/5æ˜Ÿ | yes/no |
| `gacha_is_guaranteed` | å¤§ä¿åº•æ ‡è¯† | yes/no |

### 2. æ¦‚ç‡æ¨¡å‹

#### 5æ˜Ÿæ¦‚ç‡
- **åŸºç¡€æ¦‚ç‡**: 0.6% (6/1000)
- **è½¯ä¿åº• (Soft Pity)**: ä»ç¬¬74æŠ½å¼€å§‹ï¼Œæ¯æŠ½å¢åŠ  6% æ¦‚ç‡
- **ç¡¬ä¿åº• (Hard Pity)**: ç¬¬90æŠ½æ¦‚ç‡ä¸º 100%

| æŠ½æ•° | æ¦‚ç‡ | ç´¯è®¡æœŸæœ› |
|------|------|----------|
| 1-73 | 0.6% | - |
| 74 | 6.6% | - |
| 80 | 42.6% | - |
| 90 | 100% | ä¿åº• |

#### 4æ˜Ÿæ¦‚ç‡
- **åŸºç¡€æ¦‚ç‡**: 5.1% (51/1000)
- **è½¯ä¿åº•**: ç¬¬9æŠ½å¼€å§‹æ¦‚ç‡æš´æ¶¨
- **å—å†…ä¿åº•**: æ¯10æŠ½å¿…æœ‰è‡³å°‘1ä¸ª4æ˜Ÿæˆ–5æ˜Ÿ

### 3. éšæœºæ•°ç”Ÿæˆ

**å…¬å¼** (åƒåˆ†åˆ¶):
```
rand = 937 + 17Ã—total_rolls + |treasury| + 13Ã—pity_count + 7Ã—block_index
rand = rand mod 1000
```

**ç†µæºè¯´æ˜**:
- `937`: è´¨æ•°åç§»ï¼Œç¡®ä¿åˆå§‹å€¼å¤Ÿå¤§
- `17Ã—total_rolls`: çº¿æ€§å¢é•¿å› å­
- `|treasury|`: å›½åº“é‡‘å¸çš„ç»å¯¹å€¼ï¼ˆé¿å…è´Ÿæ•°å½±å“ï¼‰
- `13Ã—pity_count`: ä¿åº•è®¡æ•°çš„è´¨æ•°æ··æ·†
- `7Ã—block_index`: å—ç´¢å¼•çš„è´¨æ•°æ··æ·†

### 4. æ ¸å¿ƒæµç¨‹

```
1. Silentå†…æ ¸è®¡ç®— (gacha_execute_single_roll_silent)
   â”œâ”€ ç”Ÿæˆéšæœºæ•° (0-999)
   â”œâ”€ è®¡ç®—5æ˜Ÿ/4æ˜Ÿé˜ˆå€¼
   â”œâ”€ åˆ¤å®šç»“æœ (tier: 0=3æ˜Ÿ, 1=4æ˜Ÿ, 2=5æ˜Ÿ)
   â”œâ”€ æ›´æ–°ä¿åº•è®¡æ•°
   â””â”€ å‘æ”¾4æ˜Ÿå¥–åŠ±ï¼ˆ5æ˜Ÿå»¶è¿Ÿï¼‰

2. äº‹ä»¶è§¦å‘ (gacha_execute_single_roll)
   â”œâ”€ å¦‚æœtier=2: è§¦å‘event.5ï¼ˆé‡‘å…‰æ¼”å‡ºï¼‰
   â”œâ”€ å¦‚æœtier=1: è§¦å‘event.20ï¼ˆ4æ˜Ÿå±•ç¤ºï¼‰
   â””â”€ å¦‚æœtier=0: è§¦å‘event.2ï¼ˆå‡¡é“ï¼‰

3. ç©å®¶ç¡®è®¤ (event option)
   â””â”€ event.5ç‚¹å‡»åæ‰å‘æ”¾5æ˜Ÿè§’è‰²
```

---

## Part 2: Architecture (æ¶æ„è®¾è®¡)

### 1. Silentå†…æ ¸æ¨¡å¼

**è®¾è®¡åŸåˆ™**: è®¡ç®—ä¸å±•ç¤ºåˆ†ç¦»

- **Silentå†…æ ¸** (`gacha_execute_single_roll_silent`):
  - åªè´Ÿè´£è®¡ç®—å’ŒçŠ¶æ€æ›´æ–°
  - ä¸è§¦å‘ä»»ä½•äº‹ä»¶
  - ä¸å‘æ”¾5æ˜Ÿå¥–åŠ±

- **Eventå±‚**:
  - è´Ÿè´£UIå±•ç¤º
  - å‘æ”¾5æ˜Ÿè§’è‰²ï¼ˆåœ¨optionä¸­ï¼‰
  - æä¾›ç©å®¶äº¤äº’

**å¥½å¤„**:
- é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºè°ƒè¯•
- Silentå†…æ ¸å¯è¢«å•æŠ½/åè¿å¤ç”¨
- äº‹ä»¶å¯ç‹¬ç«‹æµ‹è¯•

### 2. åè¿ä¼˜åŒ–

**è®¾è®¡**:
```
gacha_execute_ten_rolls {
    Loop 10æ¬¡ {
        Silentå†…æ ¸è®¡ç®—
        If 5æ˜Ÿ â†’ å¼¹event.5
        If 4æ˜Ÿ â†’ å¼¹event.20
        If 3æ˜Ÿ â†’ é™é»˜è·³è¿‡
    }
    // ä¸å†æœ‰åè¿ç»“ç®—é¡µé¢
}
```

**ç‰¹ç‚¹**:
- 3æ˜Ÿé™é»˜ï¼ˆä¸å¼¹çª—ï¼‰
- 4/5æ˜Ÿé€ä¸ªå¼¹çª—
- æ— é‡‘å¸é™åˆ¶ï¼ˆå…è®¸è´Ÿé‡‘å¸ï¼‰

### 3. å—å†…ä¿åº•æœºåˆ¶

**è§„åˆ™**: æ¯10æŠ½è‡³å°‘1ä¸ª4æ˜Ÿæˆ–5æ˜Ÿ

**å®ç°**:
```paradox
# æ¯æŠ½è®¡ç®—å—ç´¢å¼• (0-9)
block_index = total_rolls mod 10

# ç¬¬10æŠ½(index=0)æ—¶æ£€æŸ¥
if (block_index = 0 AND block_has_4star = no) {
    å¼ºåˆ¶å‡º4æ˜Ÿ
}
```

---

## Part 3: File Structure (æ–‡ä»¶ç»“æ„)

### 1. æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” | çŠ¶æ€ |
|------|------|------|
| `gacha_logic_effects.txt` | æ ¸å¿ƒé€»è¾‘ï¼ˆSilentå†…æ ¸ã€åè¿ç­‰ï¼‰ | âœ… ä½¿ç”¨ä¸­ |
| `gacha_pools.txt` | å¥–æ± å®šä¹‰ï¼ˆ5æ˜Ÿ/4æ˜Ÿ/3æ˜Ÿï¼‰ | âœ… ä½¿ç”¨ä¸­ |
| `gacha_events.txt` | ä¸»äº‹ä»¶ï¼ˆèœå•ã€ç»“æœå±•ç¤ºï¼‰ | âœ… ä½¿ç”¨ä¸­ |
| `gacha_values.txt` | æ¦‚ç‡è®¡ç®—å™¨ | âš ï¸ å·²å¼ƒç”¨ï¼ˆä»…æ–‡æ¡£ï¼‰ |

### 2. ä¸ºä»€ä¹ˆå¼ƒç”¨gacha_values.txtï¼Ÿ

**åŸå› **: EU5å¼•æ“ä¸æ”¯æŒåœ¨`scripted_effects`ä¸­ä½¿ç”¨`script_value:`å‰ç¼€

**è¡¨ç°**:
```paradox
# è¿™æ ·å†™ä¼šè¿”å›none
set_variable = { 
    name = gacha_curr_thresh5 
    value = script_value:gacha_5star_threshold_value 
}
# ç»“æœ: gacha_curr_thresh5 = none (è€Œä¸æ˜¯è®¡ç®—å‡ºçš„å€¼)
```

**è§£å†³æ–¹æ¡ˆ**: é˜ˆå€¼è®¡ç®—å†…è”åˆ°`gacha_logic_effects.txt`ç¬¬78-111è¡Œ

---

## Part 4: Bugä¿®å¤å†å²

> **æœ¬èŠ‚è®°å½•æ‰€æœ‰é‡å¤§bugåŠå…¶ä¿®å¤ï¼Œä½œä¸ºå¼€å‘ç»éªŒæ€»ç»“**

### Bug #1: å•æŠ½100%å‡º5æ˜Ÿ ğŸ”´
**æ—¥æœŸ**: 2025-11-23  
**ä¸¥é‡ç¨‹åº¦**: ä¸¥é‡

**è¡¨ç°**:
- æ¯æ¬¡å•æŠ½å¿…å‡º5æ˜Ÿ
- æ¦‚ç‡å®Œå…¨å¤±æ•ˆ

**æ ¹æœ¬åŸå› **:
```paradox
# æ—§ä»£ç : éšæœºæ•°æ°¸è¿œ=5
rand = total_rolls + treasury + pity_count
     = 5 + 0 + 0 = 5

# é˜ˆå€¼ = 6 (0.6%)
# åˆ¤å®š: 5 < 6 â†’ æ°¸è¿œå‡º5æ˜Ÿï¼
```

**ä¿®å¤æ–¹æ¡ˆ**:
- ä½¿ç”¨è´¨æ•°æ··åˆ + å›ºå®šåç§»937
- æ·»åŠ å¤šä¸ªç†µæºï¼ˆtotal_rollsÃ—17, treasury, pityÃ—13, blockÃ—7ï¼‰
- ç¡®ä¿éšæœºæ•°åœ¨0-999èŒƒå›´å‡åŒ€åˆ†å¸ƒ

**æ–‡ä»¶**: `gacha_logic_effects.txt:34-76`

---

### Bug #2: ç¡¬ä¿åº•å¤±æ•ˆ ğŸ”´
**æ—¥æœŸ**: 2025-11-23  
**ä¸¥é‡ç¨‹åº¦**: ä¸¥é‡

**è¡¨ç°**:
- 90æŠ½æœªå¿…å‡º5æ˜Ÿ
- ä¿åº•è®¡æ•°è¶…è¿‡91ä»æœªå‡ºè´§

**æ ¹æœ¬åŸå› **:
```paradox
# script_valueåœ¨effectsä¸­è¿”å›none
gacha_curr_thresh5 = script_value:gacha_5star_threshold_value
# ç»“æœ: gacha_curr_thresh5 = none

# åˆ¤å®šå¤±æ•ˆ
if (rand < none) â†’ æ°¸è¿œfalse
```

**ä¿®å¤æ–¹æ¡ˆ**:
- æ”¾å¼ƒ`script_value`ï¼Œç›´æ¥å†…è”è®¡ç®—
- ç¬¬90æŠ½æ—¶å¼ºåˆ¶è®¾ç½®é˜ˆå€¼ä¸º1000ï¼ˆ100%ï¼‰

**æ–‡ä»¶**: `gacha_logic_effects.txt:78-95`

---

### Bug #3: å—å†…ä¿åº•å¤±æ•ˆ ğŸ”´
**æ—¥æœŸ**: 2025-11-23  
**ä¸¥é‡ç¨‹åº¦**: é«˜

**è¡¨ç°**:
- 10æŠ½å¯èƒ½å…¨æ˜¯3æ˜Ÿ
- å—å†…ä¿åº•æœºåˆ¶å®Œå…¨æ— æ•ˆ

**æ ¹æœ¬åŸå› **:
```paradox
# ä½¿ç”¨äº†æœªå®šä¹‰çš„å˜é‡
limit = { var:gacha_block_index = 0 }  # block_indexä»æœªè®¡ç®—ï¼
```

**ä¿®å¤æ–¹æ¡ˆ**:
- åˆå§‹åŒ–`gacha_block_has_4star`
- æ¯æŠ½è®¡ç®—`block_index = total_rolls mod 10`
- æ¯ä¸ªæ–°å—é‡ç½®æ ‡è®°

**æ–‡ä»¶**: `gacha_logic_effects.txt:8, 21-32`

---

### Bug #4: è´Ÿé‡‘å¸å½±å“éšæœºæ•° ğŸŸ¡
**æ—¥æœŸ**: 2025-11-23  
**ä¸¥é‡ç¨‹åº¦**: ä¸­

**è¡¨ç°**:
- è´Ÿé‡‘å¸æ—¶éšæœºæ•°åå°
- è½»å¾®å½±å“æ¦‚ç‡åˆ†å¸ƒ

**æ ¹æœ¬åŸå› **:
```paradox
# ç›´æ¥åŠ ä¸Štreasury
change_variable = { name = gacha_rand add = treasury }
# å¦‚æœtreasury=-500ï¼Œrandä¼šå‡å°‘500
```

**ä¿®å¤æ–¹æ¡ˆ**:
- ä½¿ç”¨treasuryçš„ç»å¯¹å€¼
- è´Ÿæ•°æ—¶å…ˆÃ—(-1)å†åŠ åˆ°rand

**æ–‡ä»¶**: `gacha_logic_effects.txt:44-54`

---

### Bug #5: 4æ˜Ÿå¥–åŠ±æ± éšæœºæ•°æºé”™è¯¯ ğŸŸ¡
**æ—¥æœŸ**: 2025-11-23  
**ä¸¥é‡ç¨‹åº¦**: ä¸­

**è¡¨ç°**:
- 4æ˜Ÿå¥–åŠ±å¯èƒ½ä¸éšæœº
- æŠ¥é”™å˜é‡ä¸å­˜åœ¨

**æ ¹æœ¬åŸå› **:
```paradox
# ä½¿ç”¨äº†ä¸å­˜åœ¨çš„å˜é‡
set_variable = { name = gacha_4star_choice value = var:gacha_rand_ones }
# gacha_rand_onesä»æœªå®šä¹‰ï¼
```

**ä¿®å¤æ–¹æ¡ˆ**:
- æ”¹ç”¨å·²å­˜åœ¨çš„`gacha_rand`
- é€šè¿‡mod 3æ¥éšæœºé€‰æ‹©å¥–åŠ±ç±»å‹

**æ–‡ä»¶**: `gacha_pools.txt:19`

---

### Bug #6: äº‹ä»¶é¡ºåºé”™è¯¯ ğŸŸ¡  
**æ—¥æœŸ**: æ—©æœŸç‰ˆæœ¬  
**ä¸¥é‡ç¨‹åº¦**: ä¸­

**è¡¨ç°**:
- 5æ˜ŸæŠ½å¡æ—¶ï¼Œè§’è‰²äº‹ä»¶å…ˆäºé‡‘å…‰äº‹ä»¶å¼¹å‡º
- é¡ºåºä¸ç¬¦åˆåŸç¥ä½“éªŒ

**æ ¹æœ¬åŸå› **:
- Silentå†…æ ¸é”™è¯¯åœ°è°ƒç”¨äº†`gacha_handle_5star_outcome`
- å¯¼è‡´è§’è‰²åœ¨é‡‘å…‰æ¼”å‡ºå‰å°±å‘æ”¾

**ä¿®å¤æ–¹æ¡ˆ**:
- Silentå†…æ ¸åªé‡ç½®pityï¼Œä¸å‘æ”¾è§’è‰²
- è§’è‰²å‘æ”¾ç§»åˆ°event.5çš„optionä¸­

**æ–‡ä»¶**: `gacha_logic_effects.txt:146-149`, `gacha_events.txt:140-158`

---

## Part 5: è®¾è®¡å†³ç­–

### å†³ç­–1: ä¸ºä»€ä¹ˆ4æ˜Ÿç›´æ¥å‘æ”¾ï¼Œ5æ˜Ÿå»¶è¿Ÿå‘æ”¾ï¼Ÿ

**4æ˜Ÿ** (åœ¨Silentå†…æ ¸ä¸­å‘æ”¾):
- ç®€å•éšæœºå¥–åŠ±ï¼ˆé‡‘å¸/å¨æœ›/æ­£ç»Ÿæ€§ï¼‰
- æ— å¤æ‚é€»è¾‘
- æ•ˆç‡ä¼˜å…ˆ

**5æ˜Ÿ** (åœ¨event optionä¸­å‘æ”¾):
- éœ€è¦50/50åˆ¤å®š
- éœ€è¦å¤§ä¿åº•é€»è¾‘
- éœ€è¦ç©å®¶"æ­ç¤ºå‘½è¿"çš„ä»ªå¼æ„Ÿ

### å†³ç­–2: ä¸ºä»€ä¹ˆä¸ç§»é™¤åè¿ç»“ç®—é¡µé¢ï¼Ÿ

**å·²ç§»é™¤**ï¼ˆ2025-11-23ï¼‰
- ç”¨æˆ·åé¦ˆï¼šåè¿å·²ç»é€šè¿‡4/5æ˜Ÿå•ç‹¬å¼¹çª—æœ‰è¶³å¤Ÿåé¦ˆ
- ç»“ç®—é¡µé¢æ˜¾å¾—å†—ä½™

### å†³ç­–3: ä¸ºä»€ä¹ˆå…è®¸è´Ÿé‡‘å¸æŠ½å¡ï¼Ÿ

**åŸå› **:
- EU5å…è®¸ç©å®¶å€Ÿè´·
- è´Ÿé‡‘å¸åå¯ç«‹å³é€šè¿‡å€Ÿè´·è¿˜æ¬¾
- ä¸åº”è¯¥é™åˆ¶ç©å®¶çš„æ¸¸æˆä½“éªŒ

---

## Part 6: æ‰©å±•æ€§

### æ·»åŠ æ–°5æ˜Ÿè§’è‰²

1. åˆ›å»ºè§’è‰²effectæ–‡ä»¶(`gacha_xxx_effects.txt`)
2. åˆ›å»ºè§’è‰²eventæ–‡ä»¶(`gacha_xxx_events.txt`)
3. åœ¨`gacha_pools.txt`ä¸­æ›´æ–°å¥–æ± :
   ```paradox
   gacha_pool_5star_limited = {
       gacha_create_xxx_effect = yes
   }
   ```

### ä¿®æ”¹æ¦‚ç‡

ä¿®æ”¹`gacha_logic_effects.txt`ä¸­çš„å†…è”è®¡ç®—:
- 5æ˜ŸåŸºç¡€æ¦‚ç‡: ç¬¬79è¡Œ
- 5æ˜Ÿè½¯ä¿åº•: ç¬¬82-89è¡Œ
- 5æ˜Ÿç¡¬ä¿åº•: ç¬¬92-95è¡Œ
- 4æ˜ŸåŸºç¡€æ¦‚ç‡: ç¬¬98è¡Œ
- 4æ˜Ÿè½¯ä¿åº•: ç¬¬101-109è¡Œ

---

## é™„å½•: å…³é”®ä»£ç ç‰‡æ®µ

### éšæœºæ•°ç”Ÿæˆ
```paradox
# è´¨æ•°æ··åˆ + å›ºå®šåç§»
rand = 937 + 17Ã—total_rolls + |treasury| + 13Ã—pity + 7Ã—block
rand = rand mod 1000
```

### ç¡¬ä¿åº•åˆ¤å®š
```paradox
if = {
    limit = { var:gacha_pity_count >= 89 }
    set_variable = { name = gacha_curr_thresh5 value = 1000 }  # 100%
}
```

### å—å†…ä¿åº•
```paradox
if = {
    limit = { var:gacha_block_index = 0 var:gacha_block_has_4star = no }
    set_variable = { name = gacha_is_4star_win value = yes }  # å¼ºåˆ¶4æ˜Ÿ
}
```

---

**æ–‡æ¡£ç»´æŠ¤è€…**: AI + sansm  
**è®¸å¯**: MIT
