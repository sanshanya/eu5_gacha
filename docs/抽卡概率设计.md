要在 EU5 (Project Caesar) 的 Jomini 引擎中完美复刻《原神》的 **“保底 + 软保底 + 50/50 歪卡”** 机制，我们需要脱离简单的 `random_list`，转而使用 **“伪随机数生成 (PRNG) + 动态阈值判定”** 的逻辑。

### 核心逻辑拆解

我们需要三个核心变量（全局或存储在玩家国家身上）：

1. **`gacha_pity_count`**：当前垫了多少抽（0~89）。
2. **`gacha_is_guaranteed`**：大保底标识（yes = 下次必出 UP，no = 50% 歪）。
3. **`gacha_rng_roll`**：每次抽卡生成的 1-1000 的随机数。

---

### 1. 第一步：定义概率阈值 (Math)

我们需要一个脚本数值 (`script_value`) 来计算**“这一抽的出货率是多少”**。
基准是千分制（1000 = 100%）。

* 1-73 抽：0.6% -> 阈值 **6**
* 74 抽：6.6% -> 阈值 **66**
* 75 抽：12.6% -> 阈值 **126**
* ...
* 90 抽：100% -> 阈值 **1000**

**文件：`common/script_values/gacha_values.txt`**

```paradox
# 计算当前这一抽的 5星 概率阈值 (千分比)
gacha_5star_threshold_value = {
    value = 6  # 基础概率 0.6% (6/1000)

    # === 软保底机制 (Soft Pity) ===
    # 从第 74 抽开始 (pity_count >= 73)，每抽增加 6% (60/1000)
    if = {
        limit = {
            scope:actor = { check_variable = { name = gacha_pity_count value >= 73 } }
        }
        add = {
            value = scope:actor.var:gacha_pity_count
            subtract = 73
            multiply = 60  # (当前抽数 - 73) * 6%
            add = 60       # 第 74 抽本身加 6%
        }
    }

    # === 硬保底机制 (Hard Pity) ===
    # 第 90 抽 (pity_count = 89)，概率直接拉满
    if = {
        limit = {
            scope:actor = { check_variable = { name = gacha_pity_count value >= 89 } }
        }
        value = 1000
    }
}
```

---

### 2. 第二步：核心抽卡逻辑 (Logic)

这是整个系统的大脑。我们在单次抽卡中执行以下流程：

1. 生成 1-1000 的随机数。
2. 对比上面的阈值。
3. 如果 **中奖 (5星)**：进入 50/50 判定逻辑。
4. 如果 **未中奖**：垫子 +1，给 3星/4星 垃圾。

**文件：`common/scripted_effects/gacha_logic_effects.txt`**

```paradox
# ============================================================
# 单次抽卡执行器 (模拟原神机制)
# ============================================================
gacha_execute_single_roll = {
    # 1. 生成随机数 (1-1000)
    # 注意：EU5 的具体随机数语法可能略有不同，这里假设标准 Jomini 写法
    set_variable = {
        name = gacha_rng_roll
        value = {
            min = 1
            max = 1000
        }
    }

    # 2. 判定是否出金
    if = {
        # 条件：随机数 <= 当前概率阈值
        limit = {
            check_variable = {
                name = gacha_rng_roll
                value <= gacha_5star_threshold_value # 调用上面的数学公式
            }
        }
      
        # === 【出金了！】 ===
        gacha_handle_5star_outcome = yes
    }
    else = {
        # === 【没出金】 ===
        # 垫子 +1
        change_variable = { name = gacha_pity_count add = 1 }
      
        # 发放安慰奖 (3星/4星)
        # 这里为了简化，暂不模拟 4星 的 10 抽保底，只给垃圾
        gacha_give_3star_trash = yes
    }
}

# ============================================================
# 五星处理逻辑 (50/50 与 大保底)
# ============================================================
gacha_handle_5star_outcome = {
    # 1. 先重置垫子 (Pity Reset)
    set_variable = { name = gacha_pity_count value = 0 }

    # 2. 判定是不是 UP 角色
    if = {
        # 情况 A: 必定 UP (大保底生效中)
        limit = {
            has_variable = gacha_is_guaranteed
        }
        gacha_get_up_character = yes
        remove_variable = gacha_is_guaranteed # 消耗大保底
    }
    else = {
        # 情况 B: 50/50 赌命
        random_list = {
            50 = {
                # 赢了：获得 UP
                gacha_get_up_character = yes
                # 不需要设变量，下次还是 50/50
            }
            50 = {
                # 歪了：获得常驻
                gacha_get_standard_character = yes
                # 加上大保底标记，下次必中
                set_variable = { name = gacha_is_guaranteed value = yes }
            }
        }
    }
}

# ============================================================
# 实际发放奖励 (Helper Effects)
# ============================================================
gacha_get_up_character = {
    # 获得心海 (复用你之前的逻辑)
    # 检查是否已拥有 -> 命座+1 或 创角
    if = {
        limit = { has_global_variable = gacha_xinhai_is_summoned }
        # 命座 +1
        change_variable = { name = gacha_constellation_lvl add = 1 }
        gacha_apply_constellation_stats_effect = { who = xinhai }
      
        # 视觉反馈：金色传说
        trigger_event_non_silently = xinhai_events.constellation_up # 你需要写这个小事件
    }
    else = {
        # 第一次获得
        trigger_event_non_silently = xinhai_events.1
    }
}

gacha_get_standard_character = {
    # 歪了！给个“七七”或者“刻晴”
    # 这里暂时给个通用的 5 星甚至只是大量威望
    # 未来你可以做一个 standard_characters_pool
    add_prestige = 50
    add_legitimacy = 10
  
    # 弹窗告诉玩家歪了
    # trigger_event_non_silently = gacha_wish.lost_50_50
}

gacha_give_3star_trash = {
    # 蓝天白云
    add_gold = 1 # 返一点蚊子腿
    # 或者给一点点人力/行政点
}
```

---

### 3. 调试与监控 (Debug UI)

为了验证这套复杂的数学逻辑是否生效，强烈建议在“祈愿菜单”的描述里加上调试信息。

修改 `in_game/events/gacha_events.txt` 中的 `desc`：

```yaml
l_simp_chinese:
 gacha_wish_menu.1.desc: "当前祈愿状态：\n\n已垫抽数：[Root.GetVariable('gacha_pity_count').GetValue]/90\n下个五星概率：[Root.GetScriptValue('gacha_5star_threshold_value')|1]‰\n当前是否大保底：[Root.GetVariable('gacha_is_guaranteed') ? '是' : '否']\n\n投入资源，祈求命运的回应吧。"
```

*(注意：具体 `GetValue` 写法需参考 EU5 最新的 Localization 语法，如果报错可以暂时去掉)*

### 4. 总结

这套系统完美复刻了：

1. **0.6% 基础概率**：通过 `script_value` 控制。
2. **74 抽开始概率暴涨**：通过 `script_value` 里的 `if (pity >= 73)` 线性增加阈值。
3. **90 抽必出**：通过 `value = 1000` 强制命中。
4. **50/50 与大保底**：通过 `gacha_is_guaranteed` 变量进行状态机切换。

你现在的 Mod 已经不仅仅是一个换皮 Mod 了，你正在把一套完整的**现代扭蛋算法**植入到 P社引擎中。这非常酷！
