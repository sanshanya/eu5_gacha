# ==============================================================================
# Liyue (璃月) - Nation Creation / Setup Effects
# ==============================================================================

# ------------------------------------------------------------------------------
# Create Liyue (GL1) from the Liyue Plan project.
#
# Scope:
# - root = country (the overlord / player country)
# ------------------------------------------------------------------------------
gacha_create_liyue_nation_from_plan = {
	# The country that is running this effect (the overlord / player country)
	save_scope_as = liyue_overlord

	# Preconditions (soft): only proceed when it makes sense
	if = {
		limit = {
			is_ai = no
			NOT = { country_exists = c:GL1 }
			location:dongguan = { owner = scope:liyue_overlord }
			# “在东莞建立市场” = 东莞成为其市场的所在地
			location:dongguan = { this = market.location }
		}

			# Find Keqing for THIS overlord first (MP-safe; avoids picking other players' Keqing).
			clear_saved_scope = keqing_char
				scope:liyue_overlord = {
					random_character = {
						limit = {
							is_alive = yes
						has_character_modifier = gacha_keqing_modifier
					}
						save_scope_as = keqing_char
					}
				}

				# World-unique: Keqing must be owned by the overlord (no global fallback / no stealing in MP).
				if = {
					limit = { exists = scope:keqing_char }

					# 1) Add core on Dongguan and create the country from our cores
					location:dongguan = { add_core = c:GL1 }
					create_country_from_cores_in_our_locations = c:GL1

				# Success path
				if = {
					limit = { country_exists = c:GL1 }

					# Unlock: once Liyue is founded, enable the Liyue pool globally for all players
					set_global_variable = { name = gacha_liyue_pool_unlocked value = 1 }

					# Start hidden Liyue auto-recruitment timer (monthly, fires every 12 months)
					situation:gacha_liyue_auto_recruitment ?= {
						set_variable = { name = target_country value = c:GL1 }
						set_variable = { name = gacha_liyue_recruit_months value = 0 }
					}
					if = {
						limit = { NOT = { situation:gacha_liyue_auto_recruitment = { situation_is_active = yes } } }
						activate_situation = situation:gacha_liyue_auto_recruitment
					}

					# Ensure Dongguan belongs to Liyue (some setups may not auto-transfer)
					if = {
						limit = { location:dongguan = { owner = scope:liyue_overlord } }
						location:dongguan = { change_location_owner = c:GL1 }
				}

			# Transfer Keqing country modifiers away from the overlord (optional safety)
			remove_country_modifier = gacha_keqing_country_modifier
			remove_country_modifier = gacha_keqing_c1_country_modifier
			remove_country_modifier = gacha_keqing_c2_country_modifier
			remove_country_modifier = gacha_keqing_c4_country_modifier
			remove_country_modifier = gacha_keqing_c5_country_modifier
			remove_country_modifier = gacha_keqing_c6_country_modifier

			# Configure Liyue (government / capital / ruler / subject)
			c:GL1 = {
				# Avoid showing as a low rank like “伯国”
				set_country_rank_effect = { rank = country_rank:rank_kingdom }

				# Capital: Dongguan (hard requirement), fallback just in case
				if = {
					limit = { location:dongguan = { owner = c:GL1 } }
					set_capital = location:dongguan
				}
				else = {
					ordered_owned_location = {
						order_by = development
						max = 1
						save_scope_as = liyue_capital_loc
					}
					set_capital = scope:liyue_capital_loc
					clear_saved_scope = liyue_capital_loc
				}

				# AI 很难主动建造（成本/需求/权重等），因此在璃月建国时直接建好“璃月港”
				if = {
					limit = { location:dongguan = { owner = c:GL1 } }
					location:dongguan = {
						if = {
							limit = { NOT = { has_building = building_type:gacha_liyue_harbor } }
							change_building_level_in_location = { building = building_type:gacha_liyue_harbor value = 1 }
						}
					}
				}

				change_culture = culture:yuehai_culture
				change_religion = religion:sanjiao
				change_government_type = government_type:monarchy
				change_heir_selection = heir_selection:cognatic_primogeniture

				# Move Keqing to Liyue first, then set as ruler (more stable)
				if = {
					limit = { exists = scope:keqing_char }
					scope:keqing_char = { move_country = c:GL1 }
				}

				if = {
					limit = { exists = scope:keqing_char }
					# Dynasty: ensure it exists and Keqing belongs to it
					if = {
						limit = { NOT = { dynasty_exists = gacha_keqing_dynasty } }
						create_named_dynasty = gacha_keqing_dynasty
					}

					# Replace the auto-generated monarch with Keqing
					ruler_or_regent ?= { save_scope_as = liyue_old_ruler }

					scope:keqing_char = {
						change_dynasty = dynasty:gacha_keqing_dynasty
						change_character_estate = estate_type:crown_estate
					}
					set_new_ruler = scope:keqing_char
					scope:keqing_char = { gacha_keqing_apply_country_modifiers = yes }

					# Remove placeholder royals (avoid UI showing extra “king” etc.)
					if = {
						limit = { exists = scope:liyue_old_ruler }
						scope:liyue_old_ruler = {
							if = {
								limit = { this != scope:keqing_char }
								kill_character_silently = { target = this reason = vanished }
							}
						}
						clear_saved_scope = liyue_old_ruler
					}

					if = {
						limit = { NOT = { has_variable = gacha_liyue_placeholder_royals_cleaned } }
						every_character = {
							limit = {
								is_alive = yes
								has_estate = estate_type:crown_estate
								NOT = { has_character_modifier = gacha_keqing_modifier }
							}
							kill_character_silently = { target = this reason = vanished }
						}
						set_variable = { name = gacha_liyue_placeholder_royals_cleaned value = yes }
					}
				}

				# Temporary economic boons
				add_country_modifier = { modifier = gacha_liyue_foundation_boom_modifier years = 10 mode = add }

				# Make Liyue our subject (player-only safeguards exist in subject type)
				make_subject_of = {
					target = scope:liyue_overlord
					type = subject_type:gacha_archon_vassal
				}
			}

			# Cleanup
			clear_saved_scope = keqing_char

				# Notify the overlord
				trigger_event_non_silently = gacha_nation_events.1
			}
			# Failure path (throttled to avoid monthly spam)
					else = {
						if = {
							limit = { NOT = { has_variable = gacha_liyue_create_failed_notice_lock } }
							set_variable = { name = gacha_liyue_create_failed_notice_lock months = 1 }
							trigger_event_non_silently = gacha_nation_events.2
						}
						clear_saved_scope = keqing_char
					}
				}
				else = {
					if = {
						limit = { NOT = { has_variable = gacha_liyue_create_failed_notice_lock } }
						set_variable = { name = gacha_liyue_create_failed_notice_lock months = 1 }
						trigger_event_non_silently = gacha_nation_events.2
					}
					clear_saved_scope = keqing_char
				}
		}

	clear_saved_scope = liyue_overlord
}

# ==============================================================================
# Liyue - Auto Recruitment (AI)
# 说明：
# - 由 situation:gacha_liyue_auto_recruitment 每 12 个月触发一次（建国后 1 年第一次触发）
# - 按固定顺序招募“璃月池”角色（目前仅：凝光）
# - 世界唯一：若玩家已抢先召唤，则璃月跳过该角色（不偷人、不发补偿）
# - AI 简化：首次招募即直接满命（C6），避免 AI 抽卡重复与事件刷屏
# ==============================================================================

gacha_liyue_ai_recruit_liyue_pool_once = {
	# Only for AI-controlled Liyue (GL1) and only after the pool is globally unlocked
	if = {
		limit = {
			is_ai = yes
			has_global_variable = gacha_liyue_pool_unlocked
		}

		# 持久索引：固定顺序（将来璃月池扩容只需在此追加分支）
		if = { limit = { NOT = { has_variable = gacha_liyue_ai_pool_idx } } set_variable = { name = gacha_liyue_ai_pool_idx value = 0 } }

		# 池大小（目前仅 1：凝光）
		set_local_variable = { name = gacha_liyue_pool_size value = 1 }

		# 试探一次：最多遍历池大小次，找到第一个“尚未被世界召唤”的角色
		set_local_variable = { name = gacha_scan_tries value = 0 }
		set_local_variable = { name = gacha_scan_idx value = 0 }
		if = { limit = { has_variable = gacha_liyue_ai_pool_idx } set_local_variable = { name = gacha_scan_idx value = var:gacha_liyue_ai_pool_idx } }

		set_local_variable = { name = gacha_found_bool value = 0 }
		while = {
			limit = {
				local_var:gacha_scan_tries < local_var:gacha_liyue_pool_size
				local_var:gacha_found_bool = 0
			}

			# Wrap idx
			if = {
				limit = { local_var:gacha_scan_idx >= local_var:gacha_liyue_pool_size }
				set_local_variable = { name = gacha_scan_idx value = 0 }
			}

			# idx 0 -> Ningguang
			if = {
				limit = {
					local_var:gacha_scan_idx = 0
					NOT = { has_global_variable = gacha_ningguang_is_summoned }
				}
				gacha_liyue_ai_force_c6_ningguang = yes
				set_local_variable = { name = gacha_found_bool value = 1 }
			}

			# Advance scan
			if = {
				limit = { local_var:gacha_found_bool = 0 }
				change_local_variable = { name = gacha_scan_idx add = 1 }
				change_local_variable = { name = gacha_scan_tries add = 1 }
			}
		}

		# 找到后：下一次从 (idx+1) 开始，保持固定顺序
		if = {
			limit = { local_var:gacha_found_bool = 1 }
			change_local_variable = { name = gacha_scan_idx add = 1 }
			if = {
				limit = { local_var:gacha_scan_idx >= local_var:gacha_liyue_pool_size }
				set_local_variable = { name = gacha_scan_idx value = 0 }
			}
			set_variable = { name = gacha_liyue_ai_pool_idx value = local_var:gacha_scan_idx }
		}
	}
}

gacha_liyue_ai_force_c6_ningguang = {
	# World-unique precondition: only create if she doesn't exist anywhere yet
	if = {
		limit = { NOT = { has_global_variable = gacha_ningguang_is_summoned } }

		# AI 简化：直接创建并拉到满命（C6），不触发任何剧情事件
		create_character = {
			first_name = gacha_first_name_ningguang
			last_name = gacha_last_name_ningguang
			female = yes
			age = 500
			culture = culture:gacha_culture
			religion = religion:sanjiao
			birth_location = location:la_mothe_en_bassigny
			estate = estate_type:gacha_estate
			adm = { 80 90 }
			dip = { 90 100 }
			mil = { 60 75 }
			create_in_limbo = yes
			save_scope_as = new_char
		}

		if = {
			limit = { exists = scope:new_char }
			scope:new_char = {
				# 1) Register at C0
				gacha_register_new_character = { who = ningguang }

				# 2) Ensure C0 trait state exists
				gacha_ningguang_update_traits = yes

				# 3) Upgrade to C6 (delta steps; no events)
				while = {
					limit = { var:gacha_constellation_lvl < 6 }
					change_variable = { name = gacha_constellation_lvl add = 1 }
					gacha_apply_constellation_stats_effect = { who = ningguang }
					gacha_ningguang_update_traits = yes
				}

				# 4) Apply country modifiers (idempotent rebuild)
				gacha_ningguang_apply_country_modifiers = yes
			}

			set_global_variable = { name = gacha_ningguang_is_summoned value = 1 }
			clear_saved_scope = new_char
		}

		# Avoid polluting UI saved scopes
		clear_saved_scope = gacha_last_pulled_char
		clear_saved_scope = gacha_c3_target_char
	}
}
